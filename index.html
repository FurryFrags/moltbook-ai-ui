<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>MoltBook — Ashen Portal (Agent + Browser)</title>
<style>
  body{font-family:sans-serif;margin:0;background:#0f0f10;color:#eee}
  #app{display:grid;grid-template-columns:360px 1fr 360px;gap:12px;padding:12px;height:100vh;box-sizing:border-box}
  .panel{background:#111;border-radius:8px;padding:12px;overflow:auto}
  .panel h3{margin:0 0 8px 0}
  #messages{height:18vh;overflow:auto}
  .msg{padding:8px;border-radius:6px;margin-bottom:8px;background:#0b0b0b}
  .controls{display:flex;gap:6px}
  input[type=text],textarea{width:100%;padding:8px;background:#0b0b0b;border:1px solid #222;color:#eee;border-radius:6px}
  button{background:#1f6feb;color:#fff;border:none;padding:8px;border-radius:6px;cursor:pointer}
  .tab{padding:8px;border-radius:6px;margin-bottom:6px;background:#0b0b0b;cursor:pointer}
  .console{font-family:monospace;font-size:12px;background:#060606;padding:8px;border-radius:6px;height:26vh;overflow:auto}
  .small{font-size:12px;color:#aaa}
  .tab-id { font-family: monospace; color:#9ad; display:block; margin-bottom:6px; }
  #replyArea { white-space:pre-wrap; padding:8px; background:#090909; border-radius:6px; min-height:60px }
  #tabContent { white-space:pre-wrap; padding:12px; background:#060606; border-radius:6px; margin-top:12px; max-height:40vh; overflow:auto; font-family:monospace; font-size:13px; }
  #embedContainer { width:100%; height:420px; background:#000; border-radius:6px; overflow:hidden; position:relative; }
  iframe.embed { width:100%; height:100%; border:0; display:block; }
  .embed-controls{display:flex;gap:8px;margin-top:8px}
  .embed-mode-note{font-size:12px;color:#8ecbff;margin-top:6px}
  label.switch { display:flex; gap:8px; align-items:center; cursor:pointer; }
  input[type=checkbox] { width:16px; height:16px; }
  #evidenceList { margin-top:12px; background:#0b0b0b;padding:8px;border-radius:6px; font-family:monospace; font-size:13px; max-height:30vh; overflow:auto }
  .evidence-item { padding:8px; border-radius:6px; margin-bottom:8px; background:#070707; }
  .evidence-title { font-weight:600; color:#9ad; margin-bottom:6px; }
  .small-muted { font-size:12px; color:#888; }
  .answer-meta { margin-top:8px; font-size:12px; color:#9bc; }
  .answer-warn { color:#ffb86b; }
  .answer-ok { color:#9be39b; }
</style>
</head>
<body>
<div id="app">
  <div class="panel" id="left">
    <h3>Command Portal</h3>
    <div class="small">Password (required)</div>
    <input id="pw" type="password" placeholder="Password"/>
    <div style="height:8px"></div>
    <textarea id="input" placeholder="Chat or enter a command (JSON allowed). Example: 'Try to go to x.com'"></textarea>
    <div class="controls" style="margin-top:8px">
      <button id="sendBtn">Send (Chat)</button>
      <button id="openBtn">Open Tab</button>
    </div>

    <div style="margin-top:12px">
      <h3>Short Commands</h3>
      <div class="small">Open tab (paste URL):</div>
      <input id="openUrl" type="text" placeholder="https://example.com"/>
      <div style="height:6px"></div>
      <div class="small">Fetch / Summarize / Close: select in right pane and use buttons</div>
    </div>

    <div style="margin-top:12px">
      <h3>Conversation</h3>
      <div id="messages"></div>
    </div>

    <div style="margin-top:12px">
      <label class="switch"><input id="forceWeb" type="checkbox"/> Force web search & consolidate evidence before answering</label>
      <div class="small">When checked, Ashen will actively run the retrieval pipeline for info requests (and always try when asked).</div>
    </div>

    <div style="margin-top:12px">
      <label class="switch"><input id="liveMode" type="checkbox"/> Live internet mode (auto-refresh selected tab)</label>
      <div class="small">Keeps the selected page fresh by re-fetching it on an interval.</div>
      <div style="height:6px"></div>
      <div class="controls">
        <input id="liveSeconds" type="text" value="20" placeholder="seconds" />
        <button id="browseNowBtn">Browse URL now</button>
      </div>
    </div>
  </div>

  <div class="panel" id="center">
    <h3>Ashen Reply</h3>
    <div id="replyArea"></div>

    <h3 style="margin-top:12px">Evidence (web retrieval)</h3>
    <div id="evidenceList">No web evidence yet. Toggle "Force web search" and send a query to gather evidence.</div>

    <h3 style="margin-top:12px">Selected Tab</h3>
    <div id="embedContainer" style="display:none"></div>
    <div id="tabContent">No tab selected.</div>
  </div>

  <div class="panel" id="right">
    <h3>Agent Tabs & Console</h3>
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <button id="refreshTabs">Refresh Tabs</button>
      <button id="fetchTab">Fetch</button>
      <button id="summTab">Summarize</button>
      <button id="closeTab">Close</button>
    </div>
    <div id="tabsList"></div>
    <h3 style="margin-top:12px">Console</h3>
    <div class="console" id="console"></div>
  </div>
</div>

<!-- SoundCloud widget API will be injected when needed -->
<script>
const WORKER_URL = "https://ashen.furryfrags.workers.dev"; // change to your worker URL
const pwEl = document.getElementById('pw');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const openBtn = document.getElementById('openBtn');
const openUrl = document.getElementById('openUrl');
const messagesDiv = document.getElementById('messages');
const replyArea = document.getElementById('replyArea');
const tabContentDiv = document.getElementById('tabContent');
const embedContainer = document.getElementById('embedContainer');
const tabsList = document.getElementById('tabsList');
const consoleDiv = document.getElementById('console');
const refreshTabsBtn = document.getElementById('refreshTabs');
const fetchTabBtn = document.getElementById('fetchTab');
const summTabBtn = document.getElementById('summTab');
const closeTabBtn = document.getElementById('closeTab');
const forceWeb = document.getElementById('forceWeb');
const evidenceList = document.getElementById('evidenceList');
const liveMode = document.getElementById('liveMode');
const liveSeconds = document.getElementById('liveSeconds');
const browseNowBtn = document.getElementById('browseNowBtn');

let selectedTabId = null;
let lastTabs = [];
let scWidget = null; // SoundCloud widget instance
let liveTimer = null;
let embedFallbackTimer = null;
let cleanupUniversalEmbed = null;

const TRUSTED_NEWS_DOMAINS = [
  'apnews.com','reuters.com','bbc.com','cnn.com','nytimes.com','washingtonpost.com','theguardian.com',
  'npr.org','pbs.org','abcnews.go.com','cbsnews.com','nbcnews.com','bloomberg.com','wsj.com',
  'aljazeera.com','france24.com','dw.com','elpais.com','lemonde.fr','usatoday.com'
];

function safeParseUrl(url) {
  try { return new URL(url); } catch { return null; }
}

function normalizeEvidenceUrl(rawUrl) {
  const cleaned = cleanEvidenceText(rawUrl);
  const parsed = safeParseUrl(cleaned);
  if (!parsed) return cleaned;
  const isDdgRedirect = /duckduckgo\.com$/i.test(parsed.hostname) && parsed.pathname.startsWith('/l/');
  if (!isDdgRedirect) return cleaned;
  const embedded = parsed.searchParams.get('uddg');
  if (!embedded) return cleaned;
  try {
    return decodeURIComponent(embedded);
  } catch {
    return embedded;
  }
}

function domainFromUrl(rawUrl) {
  const parsed = safeParseUrl(rawUrl);
  return parsed ? parsed.hostname.toLowerCase() : '';
}

function isTrustedDomain(hostname) {
  return TRUSTED_NEWS_DOMAINS.some(d => hostname === d || hostname.endsWith(`.${d}`));
}

function appendMsg(who,text){ const d=document.createElement('div'); d.className='msg'; d.innerHTML=`<b>${who}:</b> ${escapeHtml(text)}`; messagesDiv.appendChild(d); messagesDiv.scrollTop = messagesDiv.scrollHeight; }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function scoreEvidenceItem(item) {
  const normalizedUrl = normalizeEvidenceUrl(item?.url || '');
  const hostname = domainFromUrl(normalizedUrl);
  const t = `${item?.title || ''} ${item?.snippet || ''} ${item?.summary || ''}`.toLowerCase();
  let score = 0;
  if (normalizedUrl && /^https?:\/\//i.test(normalizedUrl)) score += 2;
  if (hostname && isTrustedDomain(hostname)) score += 3;
  if (/wikipedia\.org$/.test(hostname)) score -= 1;
  if (/according to|reported|confirmed|official|statement|issued on/.test(t)) score += 1;
  if (/400 bad request|returned an error 400|target url returning a bad request|status code 4\d\d|status code 5\d\d/.test(t)) score -= 4;
  if (/not accurate|cannot verify|unconfirmed|likely an error|rumor|fake|satire|denied/.test(t)) score -= 2;
  if (!hostname) score -= 1;
  return score;
}

function cleanEvidenceText(v) {
  return String(v || '').replace(/\s+/g, ' ').trim();
}

function consolidateEvidence(evidence) {
  const rows = (evidence || []).map((item) => {
    const score = scoreEvidenceItem(item);
    const title = cleanEvidenceText(item.title);
    const summary = cleanEvidenceText(item.summary || item.snippet);
    const url = normalizeEvidenceUrl(item.url);
    const hostname = domainFromUrl(url);
    const trusted = isTrustedDomain(hostname);
    const combined = `${title} ${summary}`.toLowerCase();
    const negatesClaim = /not accurate|not captured|denied|unconfirmed|false|no indication/.test(combined);
    const isBroken = /400 bad request|returned an error 400|status code 4\d\d|status code 5\d\d/.test(combined);
    return { score, title, summary, url, hostname, trusted, negatesClaim, isBroken };
  }).sort((a,b)=>b.score-a.score);

  const top = rows.slice(0, 5);
  const bullets = top.map((r, i) => `${i+1}. ${r.title || '(untitled)'} — ${r.summary || '(no summary)'}${r.url ? ` [${r.url}]` : ''}`);
  const cautionCount = top.filter(x => x.negatesClaim).length;
  const brokenCount = top.filter(x => x.isBroken).length;
  const trustedCount = top.filter(x => x.trusted).length;
  const meta = {
    selected: top.length,
    contradictionRisk: cautionCount > 0,
    lowReliability: brokenCount >= Math.max(2, Math.ceil(top.length / 2)) || trustedCount === 0,
    confidence: top.length ? Math.max(0, Math.min(100, 45 + top[0].score * 8 - cautionCount * 10 - brokenCount * 8)) : 0
  };
  return { bullets, meta, top };
}

function extractGroundedSummary(rows) {
  if (!rows || !rows.length) {
    return 'I could not find enough reliable web evidence to answer confidently.';
  }
  const primary = rows[0];
  const title = primary.title || (primary.hostname ? `Source on ${primary.hostname}` : 'Top retrieved source');
  const summary = primary.summary || 'No summary was available from the retrieved evidence.';
  const brokenCount = rows.filter(r => r.isBroken).length;
  const trustedCount = rows.filter(r => r.trusted).length;
  const caution = brokenCount > 0 || trustedCount === 0
    ? 'Retrieved evidence quality is mixed (broken links and/or weak sourcing), so this should be treated as tentative.'
    : '';
  return [
    `Based on the strongest retrieved evidence, ${title}: ${summary}`,
    caution
  ].filter(Boolean).join(' ');
}

function buildGroundedReply(rawReply, evidence) {
  const { bullets, meta, top } = consolidateEvidence(evidence);
  if (!bullets.length) return { text: rawReply || '', metaHtml: '' };

  const genericReply = /according to my training data|since my training data only goes up to|i don't have any information|i don't have the capability to browse|cannot browse/i.test(rawReply || '');
  const header = genericReply
    ? 'Grounded answer (built from live retrieval evidence):'
    : 'Grounded answer (cross-checked against live retrieval evidence):';

  const groundedSummary = extractGroundedSummary(top);

  const combined = [
    header,
    '',
    `Answer: ${groundedSummary}`,
    (!genericReply && rawReply ? `\nModel draft (for reference): ${rawReply}` : ''),
    '',
    'Evidence highlights:',
    ...bullets
  ].join('\n');

  const riskClass = (meta.contradictionRisk || meta.lowReliability || meta.confidence < 50) ? 'answer-warn' : 'answer-ok';
  const riskLabel = (meta.contradictionRisk || meta.lowReliability || meta.confidence < 50)
    ? 'Conflicting and/or low-quality evidence detected — treat claims as tentative.'
    : 'Evidence appears reasonably consistent.';

  const metaHtml = `<div class="answer-meta ${riskClass}">Confidence estimate: ${meta.confidence}% · ${riskLabel}</div>`;
  return { text: combined, metaHtml };
}

async function callWorker(payload){
  try {
    const headers = { 'Content-Type':'application/json' };
    const pw = pwEl.value;
    if (pw) headers['Authorization'] = 'Bearer ' + pw;
    const resp = await fetch(WORKER_URL, {
      method:'POST',
      headers,
      body: JSON.stringify(payload)
    });
    const data = await resp.json();
    return data;
  } catch (e) {
    return { error: String(e) };
  }
}

sendBtn.onclick = async () => {
  const pw = pwEl.value;
  if(!pw){ alert('Password required'); return; }
  const text = inputEl.value.trim();
  if(!text) return;
  appendMsg('You', text);
  inputEl.value = '';
  evidenceList.innerHTML = '<div class="small-muted">Running retrieval (if enabled)...</div>';
  const res = await callWorker({
    password: pw,
    message: text,
    forceWeb: forceWeb.checked,
    liveInternet: true,
    requestedAt: new Date().toISOString()
  });
  if (res.error) { appendMsg('Error', res.error); evidenceList.innerHTML = '<div class="small-muted">Retrieval failed.</div>'; return; }
  const grounded = buildGroundedReply(res.reply || '', res.evidence || []);
  if (grounded.text) {
    replyArea.textContent = grounded.text;
    if (grounded.metaHtml) {
      const metaWrap = document.createElement('div');
      metaWrap.innerHTML = grounded.metaHtml;
      replyArea.appendChild(metaWrap.firstChild);
    }
    appendMsg('Ashen', grounded.text);
  }
  if (res.evidence) renderEvidence(res.evidence);
  if (res.tab) displayTabContent(res.tab);
  if (res.tabs) renderTabs(res.tabs);
  if (res.console) renderConsole(res.console);
};

openBtn.onclick = async () => {
  const pw = pwEl.value;
  const url = openUrl.value.trim();
  if(!pw){ alert('Password required'); return; }
  if(!url){ alert('Provide a URL'); return; }
  appendMsg('You', `open_tab ${url}`);
  const res = await callWorker({ password: pw, command: { type:'open_tab', url, fetchNow: true, summarizeAfter: true, words: 100 } });
  if (res.error) { appendMsg('Error', res.error); return; }
  if (res.tab) {
    appendMsg('System', `Opened tab ${res.tab.id} (${res.tab.finalUrl || res.tab.url})`);
    displayTabContent(res.tab);
  }
  if (res.tabs) renderTabs(res.tabs);
  if (res.console) renderConsole(res.console);
};

browseNowBtn.onclick = async () => {
  const pw = pwEl.value;
  const url = openUrl.value.trim();
  if(!pw){ alert('Password required'); return; }
  if(!url){ alert('Provide a URL'); return; }
  appendMsg('You', `browse_live ${url}`);
  const res = await callWorker({
    password: pw,
    command: { type:'open_tab', url, fetchNow: true, summarizeAfter: false },
    liveInternet: true,
    requestedAt: new Date().toISOString()
  });
  if (res.error) { appendMsg('Error', res.error); return; }
  if (res.tab) {
    selectedTabId = res.tab.id;
    displayTabContent(res.tab);
    ensureLivePolling();
    appendMsg('System', `Live browsing ${res.tab.finalUrl || res.tab.url}`);
  }
  if (res.tabs) renderTabs(res.tabs);
  if (res.console) renderConsole(res.console);
  ensureLivePolling();
};

refreshTabsBtn.onclick = async () => {
  const pw = pwEl.value;
  if(!pw){ alert('Password required'); return; }
  const res = await callWorker({ password: pw, command: { type:'list_tabs' } });
  if (res.error) { appendMsg('Error', res.error); return; }
  if (res.tabs) renderTabs(res.tabs);
  if (res.console) renderConsole(res.console);
};

function renderTabs(tabs) {
  lastTabs = tabs || [];
  tabsList.innerHTML = '';
  for (const t of (tabs || []).slice().reverse()) {
    const div = document.createElement('div');
    div.className = 'tab';
    div.innerHTML = `
      <div class="tab-id">${escapeHtml(t.id)}</div>
      <div style="font-weight:600">${escapeHtml(t.title || t.finalUrl || t.url)}</div>
      <div class="small">${escapeHtml(t.finalUrl || t.url)}</div>
      <div class="small">status: ${escapeHtml(t.status)} lastFetched: ${escapeHtml(t.lastFetchedAt || 'n/a')}</div>
    `;
    div.onclick = () => {
      selectedTabId = t.id;
      Array.from(tabsList.querySelectorAll('.tab')).forEach(el => el.style.outline = '');
      div.style.outline = '2px solid #2b6';
      displayTabContent(t);
      ensureLivePolling();
    };
    tabsList.appendChild(div);
  }
  if (!selectedTabId && lastTabs && lastTabs.length) {
    const t = lastTabs[lastTabs.length - 1];
    selectedTabId = t.id;
    displayTabContent(t);
    ensureLivePolling();
    const first = tabsList.querySelector('.tab');
    if (first) first.style.outline = '2px solid #2b6';
  }
}

function renderEvidence(evidence) {
  if (!evidence || !evidence.length) {
    evidenceList.innerHTML = '<div class="small-muted">No evidence found (worker attempted retrieval but found nothing). Try toggling Force web search and provide a clearer query or permit opening specific pages.</div>';
    return;
  }
  evidenceList.innerHTML = '';
  for (const e of evidence) {
    const el = document.createElement('div');
    el.className = 'evidence-item';
    el.innerHTML = `
      <div class="evidence-title">[${e.idx}] ${escapeHtml(e.title || '(no title)')}</div>
      <div class="small-muted">${escapeHtml(e.url || '(no url)')} — source: ${escapeHtml(e.sourceType || '(unknown)')}</div>
      <div style="height:6px"></div>
      <div>${escapeHtml((e.snippet || '').slice(0,800))}</div>
      <div style="height:8px"></div>
      <div style="font-style:italic;color:#cfc">${escapeHtml((e.summary || '').slice(0,800))}</div>
    `;
    evidenceList.appendChild(el);
  }
}

// render embed player if available (SoundCloud support)
function displayTabContent(tab) {
  if (!tab) { hideEmbed(); tabContentDiv.textContent = 'No tab selected.'; return; }

  // If embed metadata present (from worker), render the embed player
  if (tab.embed && tab.embed.type === 'soundcloud' && tab.embed.embedUrl) {
    showSoundCloudEmbed(tab.embed.embedUrl, tab);
    return;
  }

  showUniversalWebsiteEmbed(tab);

  const html = [];
  html.push(`ID: ${tab.id}`);
  html.push(`Title: ${tab.title || '(no title)'}`);
  html.push(`URL: ${tab.finalUrl || tab.url}`);
  html.push(`Status: ${tab.status}`);
  if (tab.lastFetchedAt) html.push(`Last Fetched: ${tab.lastFetchedAt}`);
  if (tab.summary) html.push(`\n--- Summary ---\n${tab.summary}`);
  if (tab.content) {
    html.push(`\n--- Content (truncated) ---\n${tab.content.slice(0, 20000)}`);
  } else {
    html.push(`\n(No content fetched yet)`);
  }
  tabContentDiv.textContent = html.join("\n\n");
}

function normalizeEmbeddableUrl(url) {
  if (!url) return '';
  if (/^https?:\/\//i.test(url)) return url;
  return `https://${url}`;
}

function toMirrorUrl(url) {
  const normalized = normalizeEmbeddableUrl(url);
  if (!normalized) return '';
  return `https://r.jina.ai/http://${normalized.replace(/^https?:\/\//i,'')}`;
}

function showUniversalWebsiteEmbed(tab) {
  const targetUrl = normalizeEmbeddableUrl(tab.finalUrl || tab.url || '');
  if (!targetUrl) {
    hideEmbed();
    return;
  }

  if (cleanupUniversalEmbed) {
    cleanupUniversalEmbed();
    cleanupUniversalEmbed = null;
  }

  if (embedFallbackTimer) {
    clearTimeout(embedFallbackTimer);
    embedFallbackTimer = null;
  }

  embedContainer.innerHTML = '';
  embedContainer.style.display = 'block';

  const iframe = document.createElement('iframe');
  iframe.className = 'embed';
  iframe.referrerPolicy = 'no-referrer';

  let switched = false;
  let directLoaded = false;
  let isDirectMode = true;
  let userManuallySwitched = false;

  const note = document.createElement('div');
  note.className = 'embed-mode-note';
  note.textContent = `Viewing: direct website frame (${targetUrl})`;

  const useDirect = (manual = false) => {
    if (manual) userManuallySwitched = true;
    isDirectMode = true;
    switched = false;
    directLoaded = false;
    iframe.src = targetUrl;
    note.textContent = `Viewing: direct website frame (${targetUrl})`;
  };
  const useMirror = (manual = false) => {
    if (manual) userManuallySwitched = true;
    isDirectMode = false;
    switched = true;
    iframe.src = toMirrorUrl(targetUrl);
    note.textContent = 'Viewing: mirror mode (r.jina.ai) for sites that block iframes.';
  };

  iframe.onload = () => {
    if (isDirectMode) {
      directLoaded = true;
    }
  };
  iframe.onerror = () => {
    if (isDirectMode && !switched) {
      useMirror();
    }
  };

  iframe.src = targetUrl;
  embedContainer.appendChild(iframe);

  const controls = document.createElement('div');
  controls.className = 'embed-controls';
  controls.innerHTML = `<button id="embedDirect">Direct</button><button id="embedMirror">Mirror</button><button id="embedOpen">Open</button>`;
  embedContainer.appendChild(controls);
  embedContainer.appendChild(note);

  document.getElementById('embedDirect').onclick = () => useDirect(true);
  document.getElementById('embedMirror').onclick = () => useMirror(true);
  document.getElementById('embedOpen').onclick = () => window.open(targetUrl, '_blank', 'noopener,noreferrer');

  // Auto-fallback improves "all websites" coverage for X-Frame-Options blocked pages.
  embedFallbackTimer = setTimeout(() => {
    if (!directLoaded && !switched && !userManuallySwitched) {
      useMirror();
    }
  }, 2200);

  cleanupUniversalEmbed = () => {
    if (embedFallbackTimer) {
      clearTimeout(embedFallbackTimer);
      embedFallbackTimer = null;
    }
    iframe.onload = null;
    iframe.onerror = null;
  };
}


function showSoundCloudEmbed(embedUrl, tab) {
  if (cleanupUniversalEmbed) {
    cleanupUniversalEmbed();
    cleanupUniversalEmbed = null;
  }

  embedContainer.innerHTML = '';
  embedContainer.style.display = 'block';
  tabContentDiv.textContent = '';
  // create iframe
  const iframe = document.createElement('iframe');
  iframe.className = 'embed';
  iframe.src = embedUrl + (embedUrl.includes('?') ? '&' : '?') + 'visual=true';
  iframe.setAttribute('allow', 'autoplay');
  iframe.setAttribute('id', 'sc-iframe-' + tab.id);
  embedContainer.appendChild(iframe);

  // inject widget script if not already present
  if (!window.SC) {
    const s = document.createElement('script');
    s.src = 'https://w.soundcloud.com/player/api.js';
    s.onload = ()=> { initSCWidget(iframe); };
    document.body.appendChild(s);
  } else {
    initSCWidget(iframe);
  }

  // simple controls
  const controls = document.createElement('div');
  controls.className = 'embed-controls';
  controls.innerHTML = `<button id="sc-play">Play</button><button id="sc-pause">Pause</button><button id="sc-seek">Seek +10s</button>`;
  embedContainer.appendChild(controls);

  document.getElementById('sc-play').onclick = ()=> { if (scWidget) scWidget.play(); };
  document.getElementById('sc-pause').onclick = ()=> { if (scWidget) scWidget.pause(); };
  document.getElementById('sc-seek').onclick = ()=> { if (scWidget) scWidget.seekTo && scWidget.seekTo((scWidget.getPosition?scWidget.getPosition():0) + 10000); };
}

function initSCWidget(iframe){
  try {
    scWidget = window.SC.Widget(iframe);
    // optional: listen to events
    scWidget.bind(window.SC.Widget.Events.PLAY, ()=> console.log('SC play'));
    scWidget.bind(window.SC.Widget.Events.PAUSE, ()=> console.log('SC pause'));
  } catch (e) { console.warn('SC Widget init failed', e); }
}

function hideEmbed() {
  if (cleanupUniversalEmbed) {
    cleanupUniversalEmbed();
    cleanupUniversalEmbed = null;
  }

  embedContainer.style.display = 'none';
  embedContainer.innerHTML = '';
  scWidget = null;
}

fetchTabBtn.onclick = async () => {
  if(!selectedTabId) { alert('Select a tab'); return; }
  const pw = pwEl.value; if(!pw) { alert('Password required'); return; }
  const res = await callWorker({ password: pw, command: { type:'fetch_tab', tabId: selectedTabId } });
  if (res.error) { appendMsg('Error', res.error); return; }
  if (res.tab) appendMsg('System', `Fetched ${res.tab.id} (${res.tab.finalUrl || res.tab.url})`);
  if (res.tabs) renderTabs(res.tabs);
  if (res.console) renderConsole(res.console);
  if (res.tab) displayTabContent(res.tab);
};

summTabBtn.onclick = async () => {
  if(!selectedTabId) { alert('Select a tab'); return; }
  const pw = pwEl.value; if(!pw) { alert('Password required'); return; }
  const res = await callWorker({ password: pw, command: { type:'summarize_tab', tabId: selectedTabId, words: 120 }});
  if (res.error) { appendMsg('Error', res.error); return; }
  if (res.result) appendMsg('System', `Summary for ${selectedTabId}: ${res.result.summary}`);
  if (res.tab) displayTabContent(res.tab);
  if (res.tabs) renderTabs(res.tabs);
  if (res.console) renderConsole(res.console);
};

closeTabBtn.onclick = async () => {
  if(!selectedTabId) { alert('Select a tab'); return; }
  const pw = pwEl.value; if(!pw) { alert('Password required'); return; }
  const res = await callWorker({ password: pw, command: { type:'close_tab', tabId: selectedTabId }});
  if (res.error) { appendMsg('Error', res.error); return; }
  appendMsg('System', `Closed ${selectedTabId}`);
  selectedTabId = null;
  if (res.tabs) renderTabs(res.tabs);
  if (res.console) renderConsole(res.console);
  ensureLivePolling();
};

liveMode.onchange = () => {
  if (liveMode.checked) {
    appendMsg('System', 'Live internet mode enabled. Selected tab will auto-refresh.');
  } else {
    appendMsg('System', 'Live internet mode paused.');
  }
  ensureLivePolling();
};

liveSeconds.onchange = () => {
  ensureLivePolling();
};

function ensureLivePolling() {
  if (liveTimer) {
    clearInterval(liveTimer);
    liveTimer = null;
  }
  if (!liveMode.checked || !selectedTabId) return;
  const everyMs = Math.max(5, Number(liveSeconds.value) || 20) * 1000;
  liveTimer = setInterval(refreshSelectedTab, everyMs);
}

async function refreshSelectedTab() {
  if (!selectedTabId || !liveMode.checked) return;
  const pw = pwEl.value;
  if (!pw) return;
  const res = await callWorker({
    password: pw,
    command: { type:'fetch_tab', tabId: selectedTabId },
    liveInternet: true,
    requestedAt: new Date().toISOString()
  });
  if (res.error) {
    appendMsg('System', `Live refresh failed: ${res.error}`);
    return;
  }
  if (res.tab) {
    displayTabContent(res.tab);
  }
  if (res.tabs) renderTabs(res.tabs);
  if (res.console) renderConsole(res.console);
}

function renderConsole(entries) {
  consoleDiv.innerHTML = '';
  for (const e of (entries || []).slice(-200).reverse()) {
    const line = document.createElement('div');
    line.innerHTML = `<span class="small">[${escapeHtml(e.ts)}]</span> <b>${escapeHtml(e.level)}</b> ${escapeHtml(e.msg)}`;
    consoleDiv.appendChild(line);
  }
  consoleDiv.scrollTop = consoleDiv.scrollHeight;
}

// initial load
(async ()=> {
  const res = await callWorker({ password: pwEl.value||"", command: { type:'list_tabs' } });
  if (res && res.tabs) renderTabs(res.tabs);
  if (res && res.console) renderConsole(res.console);
})();
</script>
</body>
</html>
