<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MoltBook – Ashen</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; padding: 20px; }
    #app { max-width: 820px; margin: auto; }
    #chat { background:#0e0e0e; padding:12px; border-radius:8px; }
    textarea { width:100%; height:80px; background:#121212; color:#eee; border:1px solid #333; padding:8px; }
    .row { display:flex; gap:10px; align-items:center; margin-top:8px; }
    .col { flex:1; }
    label { display:block; font-size:13px; margin-bottom:6px; color:#ddd; }
    input[type="range"] { width:100%; }
    button { padding:10px; width:100%; margin-top:8px; background:#2b2b2b; color:#fff; border:none; cursor:pointer; border-radius:6px; }
    .msg { margin:10px 0; padding:8px; border-radius:6px; background:#161616; }
    .meta { font-size:12px; color:#aaa; margin-top:6px; }
    .sl { display:flex; gap:12px; align-items:center; }
    .val { min-width:72px; text-align:right; color:#cfcfcf; font-size:12px; }
  </style>
</head>
<body>
  <div id="app">
    <h2>MoltBook — Ashen</h2>

    <div id="controls" style="margin-bottom:12px;">
      <label>Password (required)</label>
      <input id="password" type="password" placeholder="Password" style="width:100%; padding:8px; background:#121212; border:1px solid #333; color:#eee;" />

      <div style="margin-top:12px; color:#ddd; font-size:13px;">Tone & preference sliders — adjust how Ashen frames answers</div>

      <div style="margin-top:8px; background:#0b0b0b; padding:10px; border-radius:6px;">
        <div style="margin-bottom:8px;">
          <label>1) Political — Liberal ← → Conservative</label>
          <div class="sl"><input id="s_political" type="range" min="0" max="100" /><div class="val" id="v_political"></div></div>
        </div>

        <div style="margin-bottom:8px;">
          <label>2) Action — Aggressive ← → Passive ← → Defensive (three-way)</label>
          <div class="sl"><input id="s_action" type="range" min="0" max="100" /><div class="val" id="v_action"></div></div>
        </div>

        <div style="margin-bottom:8px;">
          <label>3) Mood — Positive ← → Negative</label>
          <div class="sl"><input id="s_mood" type="range" min="0" max="100" /><div class="val" id="v_mood"></div></div>
        </div>

        <div style="margin-bottom:8px;">
          <label>4) Confidence — Confident ← → Not confident</label>
          <div class="sl"><input id="s_confidence" type="range" min="0" max="100" /><div class="val" id="v_confidence"></div></div>
        </div>

        <div style="margin-bottom:4px;">
          <label>5) Playfulness — Playful ← → Serious</label>
          <div class="sl"><input id="s_play" type="range" min="0" max="100" /><div class="val" id="v_play"></div></div>
        </div>

        <div class="meta">Tip: center values (~50) = neutral. Move left or right to bias tone.</div>
      </div>

      <button id="saveSettings">Save settings locally</button>
    </div>

    <div id="chat">
      <div id="messages"></div>

      <textarea id="input" placeholder="Talk to Ashen..."></textarea>
      <div class="row">
        <div class="col"><button id="sendBtn">Send</button></div>
        <div style="width:160px"><button id="clearBtn">Clear chat</button></div>
      </div>

      <div class="meta" id="status"></div>
    </div>
  </div>

  <script>
    // Worker URL — CHANGE if your worker domain differs
    const WORKER_URL = "https://ashen.furryfrags.workers.dev";

    // Elements
    const sPolitical = document.getElementById("s_political");
    const sAction = document.getElementById("s_action");
    const sMood = document.getElementById("s_mood");
    const sConfidence = document.getElementById("s_confidence");
    const sPlay = document.getElementById("s_play");

    const vPolitical = document.getElementById("v_political");
    const vAction = document.getElementById("v_action");
    const vMood = document.getElementById("v_mood");
    const vConfidence = document.getElementById("v_confidence");
    const vPlay = document.getElementById("v_play");

    const saveBtn = document.getElementById("saveSettings");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("input");
    const pwd = document.getElementById("password");
    const status = document.getElementById("status");

    // Defaults
    const DEFAULTS = { political:50, action:50, mood:50, confidence:20, play:30 };

    // load settings from localStorage
    function loadSettings() {
      const raw = localStorage.getItem("ashen_settings");
      let s = raw ? JSON.parse(raw) : DEFAULTS;
      sPolitical.value = s.political; sAction.value = s.action; sMood.value = s.mood; sConfidence.value = s.confidence; sPlay.value = s.play;
      updateVals();
    }

    function updateVals() {
      vPolitical.textContent = labelPolitical(Number(sPolitical.value));
      vAction.textContent = labelAction(Number(sAction.value));
      vMood.textContent = labelMood(Number(sMood.value));
      vConfidence.textContent = labelConfidence(Number(sConfidence.value));
      vPlay.textContent = labelPlay(Number(sPlay.value));
    }

    // human-friendly labels
    function labelPolitical(v){
      if (v < 35) return `Liberal (${v})`;
      if (v <= 65) return `Center (${v})`;
      return `Conservative (${v})`;
    }
    function labelAction(v){
      if (v < 34) return `Aggressive (${v})`;
      if (v <= 66) return `Passive (${v})`;
      return `Defensive (${v})`;
    }
    function labelMood(v){ return (v < 50) ? `Positive (${v})` : `Negative (${v})`; }
    function labelConfidence(v){ return (v < 50) ? `Confident (${v})` : `Not confident (${v})`; }
    function labelPlay(v){ return (v < 50) ? `Playful (${v})` : `Serious (${v})`; }

    // save settings
    saveBtn.addEventListener("click", ()=> {
      const s = {
        political: Number(sPolitical.value),
        action: Number(sAction.value),
        mood: Number(sMood.value),
        confidence: Number(sConfidence.value),
        play: Number(sPlay.value)
      };
      localStorage.setItem("ashen_settings", JSON.stringify(s));
      status.textContent = "Settings saved locally.";
      setTimeout(()=> status.textContent = "", 2000);
    });

    // dynamic updates
    [sPolitical, sAction, sMood, sConfidence, sPlay].forEach(el => el.addEventListener("input", updateVals));
    loadSettings();

    // clear chat
    clearBtn.addEventListener("click", ()=> { messagesDiv.innerHTML = ""; localStorage.removeItem("ashen_chat"); });

    // load chat from local storage optionally
    function loadChat() {
      const raw = localStorage.getItem("ashen_chat");
      if (!raw) return;
      try {
        const arr = JSON.parse(raw);
        arr.forEach(m => {
          const d = document.createElement("div"); d.className="msg"; d.innerHTML = `<b>${m.who}:</b> ${m.text}`; messagesDiv.appendChild(d);
        });
      } catch {}
    }
    loadChat();

    // store chat locally too
    function appendLocal(who, text) {
      const raw = localStorage.getItem("ashen_chat");
      const arr = raw ? JSON.parse(raw) : [];
      arr.push({ who, text });
      localStorage.setItem("ashen_chat", JSON.stringify(arr.slice(-200)));
    }

    // send message
    async function send() {
      const text = input.value.trim();
      const password = pwd.value;
      if (!password) { status.textContent = "Password required."; return; }
      if (!text) return;
      input.value = "";
      messagesDiv.innerHTML += `<div class="msg"><b>You:</b> ${escapeHtml(text)}</div>`;
      appendLocal("You", text);

      // build settings object from sliders
      const settings = {
        political: Number(sPolitical.value),
        action: Number(sAction.value),
        mood: Number(sMood.value),
        confidence: Number(sConfidence.value),
        playfulness: Number(sPlay.value)
      };

      status.textContent = "Ashen is thinking…";

      try {
        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password, message: text, settings })
        });

        const data = await res.json();
        if (data.error) {
          messagesDiv.innerHTML += `<div class="msg"><b>Error:</b> ${escapeHtml(data.error)}</div>`;
          status.textContent = "";
          return;
        }

        const reply = data.reply || "(no reply)";
        messagesDiv.innerHTML += `<div class="msg"><b>Ashen:</b> ${escapeHtml(reply)}</div>`;
        appendLocal("Ashen", reply);
        status.textContent = "";
      } catch (e) {
        messagesDiv.innerHTML += `<div class="msg"><b>Error:</b> Ashen unreachable.</div>`;
        status.textContent = "";
      }

      // auto-scroll
      window.scrollTo(0, document.body.scrollHeight);
    }

    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", (e)=> { if(e.key === "Enter" && (e.ctrlKey || e.metaKey)) send(); });

    // small helper
    function escapeHtml(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

    // initialize numeric displays
    updateVals();
  </script>
</body>
</html>
