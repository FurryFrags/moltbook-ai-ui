<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MoltBook — Ashen (adaptive)</title>
  <style>
    body { background:#111; color:#eee; font-family:sans-serif; padding:20px; }
    #app { max-width:820px; margin:auto; }
    textarea, input[type=password] { width:100%; padding:8px; background:#121212; border:1px solid #333; color:#eee; }
    .controls { background:#0b0b0b; padding:10px; border-radius:8px; margin-bottom:12px; }
    label { display:block; color:#ddd; font-size:13px; margin-bottom:6px; }
    .sl { display:flex; gap:10px; align-items:center; }
    .sl input[type=range]{ flex:1; }
    .val { min-width:120px; text-align:right; color:#cfcfcf; font-size:12px; }
    button { padding:10px; width:100%; margin-top:8px; background:#2b2b2b; color:#fff; border:none; cursor:pointer; border-radius:6px; }
    .msg { margin:10px 0; padding:8px; border-radius:6px; background:#161616; }
    .meta { font-size:12px; color:#aaa; margin-top:6px; }
    .stats { display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
    .stat { background:#0f0f0f; border-radius:6px; padding:8px; min-width:180px; }
  </style>
</head>
<body>
  <div id="app">
    <h2>MoltBook — Ashen (adaptive)</h2>

    <div class="controls">
      <label>Password</label>
      <input id="password" type="password" placeholder="Password (required)" />
      <div style="margin-top:10px; color:#ddd;">Tone sliders — adjust primary behavior. Ashen will adapt slightly from conversation.</div>

      <div style="margin-top:8px;">
        <label>1) Political — Liberal ← → Conservative</label>
        <div class="sl"><input id="s_political" type="range" min="0" max="100" /><div class="val" id="v_political"></div></div>
      </div>

      <div style="margin-top:8px;">
        <label>2) Action — Aggressive ← → Passive ← → Defensive</label>
        <div class="sl"><input id="s_action" type="range" min="0" max="100" /><div class="val" id="v_action"></div></div>
      </div>

      <div style="margin-top:8px;">
        <label>3) Mood — Positive ← → Negative</label>
        <div class="sl"><input id="s_mood" type="range" min="0" max="100" /><div class="val" id="v_mood"></div></div>
      </div>

      <div style="margin-top:8px;">
        <label>4) Confidence — Confident ← → Not confident</label>
        <div class="sl"><input id="s_confidence" type="range" min="0" max="100" /><div class="val" id="v_confidence"></div></div>
      </div>

      <div style="margin-top:8px;">
        <label>5) Playfulness — Playful ← → Serious</label>
        <div class="sl"><input id="s_play" type="range" min="0" max="100" /><div class="val" id="v_play"></div></div>
      </div>

      <div style="margin-top:10px;" class="meta">Tip: slider is primary control; conversation nudges Ashen and applied settings show final result.</div>
      <button id="saveSettings">Save settings locally</button>
    </div>

    <div id="chatBox">
      <div id="messages"></div>
      <textarea id="input" placeholder="Talk to Ashen..."></textarea>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="sendBtn">Send</button>
        <button id="clearBtn">Clear</button>
      </div>

      <div class="stats">
        <div class="stat">
          <strong>Applied settings (what Ashen used)</strong>
          <div id="applied">None yet</div>
        </div>
        <div class="stat">
          <strong>Inferred settings (from convo)</strong>
          <div id="inferred">None yet</div>
        </div>
        <div class="stat">
          <strong>Last autonomous report</strong>
          <div id="autoReport">None yet</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Worker URL - change to your worker if different
    const WORKER = "https://ashen.furryfrags.workers.dev";

    // DOM
    const sPolitical = document.getElementById("s_political");
    const sAction = document.getElementById("s_action");
    const sMood = document.getElementById("s_mood");
    const sConfidence = document.getElementById("s_confidence");
    const sPlay = document.getElementById("s_play");

    const vPolitical = document.getElementById("v_political");
    const vAction = document.getElementById("v_action");
    const vMood = document.getElementById("v_mood");
    const vConfidence = document.getElementById("v_confidence");
    const vPlay = document.getElementById("v_play");

    const saveBtn = document.getElementById("saveSettings");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("input");
    const pwd = document.getElementById("password");

    const appliedDiv = document.getElementById("applied");
    const inferredDiv = document.getElementById("inferred");
    const autoReportDiv = document.getElementById("autoReport");

    // defaults
    const DEFAULTS = { political:50, action:50, mood:50, confidence:50, playfulness:30 };
    function loadSettings() {
      const raw = localStorage.getItem("ashen_settings");
      const s = raw ? JSON.parse(raw) : DEFAULTS;
      sPolitical.value = s.political; sAction.value = s.action; sMood.value = s.mood; sConfidence.value = s.confidence; sPlay.value = s.playfulness;
      updateLabels();
    }

    function updateLabels() {
      vPolitical.textContent = displayPolitical(Number(sPolitical.value));
      vAction.textContent = displayAction(Number(sAction.value));
      vMood.textContent = `${Number(sMood.value)} (${Number(sMood.value) < 50 ? "positive" : Number(sMood.value) > 50 ? "negative" : "neutral"})`;
      vConfidence.textContent = `${Number(sConfidence.value)} (${Number(sConfidence.value) < 50 ? "confident" : "cautious"})`;
      vPlay.textContent = `${Number(sPlay.value)} (${Number(sPlay.value) < 50 ? "playful" : "serious"})`;
    }
    function displayPolitical(v){ if (v < 35) return `Liberal (${v})`; if (v<=65) return `Center (${v})`; return `Conservative (${v})`; }
    function displayAction(v){ if (v < 34) return `Aggressive (${v})`; if (v<=66) return `Passive (${v})`; return `Defensive (${v})`; }

    [sPolitical, sAction, sMood, sConfidence, sPlay].forEach(el => el.addEventListener("input", updateLabels));
    loadSettings();

    saveBtn.addEventListener("click", ()=>{
      const s = { political: Number(sPolitical.value), action: Number(sAction.value), mood: Number(sMood.value), confidence: Number(sConfidence.value), playfulness: Number(sPlay.value) };
      localStorage.setItem("ashen_settings", JSON.stringify(s));
      alert("Saved locally.");
    });

    function appendMsg(who, text) {
      const d = document.createElement("div");
      d.className = "msg";
      d.innerHTML = `<b>${who}:</b> ${escapeHtml(text)}`;
      messagesDiv.appendChild(d);
      window.scrollTo(0, document.body.scrollHeight);
    }
    function escapeHtml(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

    async function send() {
      const text = input.value.trim();
      const password = pwd.value;
      if (!password) { alert("Password required"); return; }
      if (!text) return;
      input.value = "";
      appendMsg("You", text);

      const settings = { political: Number(sPolitical.value), action: Number(sAction.value), mood: Number(sMood.value), confidence: Number(sConfidence.value), playfulness: Number(sPlay.value) };

      try {
        const res = await fetch(WORKER, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password, message: text, settings })
        });
        const data = await res.json();
        if (data.error) {
          appendMsg("Error", data.error);
          return;
        }
        appendMsg("Ashen", data.reply || "(no reply)");
        // show inferred & applied
        if (data.inferred_settings) {
          inferredDiv.innerHTML = Object.entries(data.inferred_settings).map(([k,v]) => `<div>${k}: ${v}</div>`).join("");
        }
        if (data.applied_settings) {
          appliedDiv.innerHTML = Object.entries(data.applied_settings).map(([k,v]) => `<div>${k}: ${v}</div>`).join("");
        }
      } catch (e) {
        appendMsg("Error", "Ashen unreachable.");
      }
    }

    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", (e)=> { if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) send(); });
    clearBtn.addEventListener("click", ()=> { messagesDiv.innerHTML = ""; });

    // load last autonomous report occasionally (poll)
    async function loadAutoReport() {
      try {
        const res = await fetch(WORKER, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: pwd.value || "", message: "__status__" }) // harmless query to get internal saved report
        });
        const data = await res.json();
        if (data && data.last_autonomous_report) autoReportDiv.textContent = data.last_autonomous_report;
      } catch {}
    }

    // small interval to refresh applied/inferred periodically (optional)
    setInterval(()=>{ /* optional: fetch status if needed */ }, 60000);

  </script>
</body>
</html>
