<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>MoltBook â€” Ashen Portal (Agent + Browser)</title>
<style>
  body{font-family:sans-serif;margin:0;background:#0f0f10;color:#eee}
  #app{display:grid;grid-template-columns:360px 1fr 360px;gap:12px;padding:12px;height:100vh;box-sizing:border-box}
  .panel{background:#111;border-radius:8px;padding:12px;overflow:auto}
  .panel h3{margin:0 0 8px 0}
  #messages{height:60vh;overflow:auto}
  .msg{padding:8px;border-radius:6px;margin-bottom:8px;background:#0b0b0b}
  .controls{display:flex;gap:6px}
  input[type=text],textarea{width:100%;padding:8px;background:#0b0b0b;border:1px solid #222;color:#eee;border-radius:6px}
  button{background:#1f6feb;color:#fff;border:none;padding:8px;border-radius:6px;cursor:pointer}
  .tab{padding:8px;border-radius:6px;margin-bottom:6px;background:#0b0b0b}
  .console{font-family:monospace;font-size:12px;background:#060606;padding:8px;border-radius:6px;height:40vh;overflow:auto}
  .small{font-size:12px;color:#aaa}
</style>
</head>
<body>
<div id="app">
  <div class="panel" id="left">
    <h3>Command Portal</h3>
    <div class="small">Password (required)</div>
    <input id="pw" type="password" placeholder="Password"/>
    <div style="height:8px"></div>
    <textarea id="input" placeholder="Chat or enter a command (JSON allowed)"></textarea>
    <div class="controls" style="margin-top:8px">
      <button id="sendBtn">Send (Chat)</button>
      <button id="openBtn">Open Tab</button>
    </div>

    <div style="margin-top:12px">
      <h3>Short Commands</h3>
      <div class="small">Open tab:</div>
      <input id="openUrl" type="text" placeholder="https://example.com"/>
      <div style="height:6px"></div>
      <div class="small">Fetch / Summarize / Close: select in right pane and use buttons</div>
    </div>

    <div style="margin-top:12px">
      <h3>Conversation</h3>
      <div id="messages"></div>
    </div>
  </div>

  <div class="panel" id="center">
    <h3>Ashen Reply</h3>
    <div id="replyArea" style="white-space:pre-wrap"></div>
  </div>

  <div class="panel" id="right">
    <h3>Agent Tabs & Console</h3>
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <button id="refreshTabs">Refresh Tabs</button>
      <button id="fetchTab">Fetch</button>
      <button id="summTab">Summarize</button>
      <button id="closeTab">Close</button>
    </div>
    <div id="tabsList"></div>
    <h3 style="margin-top:12px">Console</h3>
    <div class="console" id="console"></div>
  </div>
</div>

<script>
const WORKER_URL = "https://ashen.furryfrags.workers.dev/"; // change if needed
const pwEl = document.getElementById('pw');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const openBtn = document.getElementById('openBtn');
const openUrl = document.getElementById('openUrl');
const messagesDiv = document.getElementById('messages');
const replyArea = document.getElementById('replyArea');
const tabsList = document.getElementById('tabsList');
const consoleDiv = document.getElementById('console');
const refreshTabsBtn = document.getElementById('refreshTabs');
const fetchTabBtn = document.getElementById('fetchTab');
const summTabBtn = document.getElementById('summTab');
const closeTabBtn = document.getElementById('closeTab');

let selectedTabId = null;

function appendMsg(who,text){ const d=document.createElement('div'); d.className='msg'; d.innerHTML=`<b>${who}:</b> ${escapeHtml(text)}`; messagesDiv.appendChild(d); messagesDiv.scrollTop = messagesDiv.scrollHeight; }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

async function callWorker(payload){
  try {
    const resp = await fetch(WORKER_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    return await resp.json();
  } catch (e) {
    return { error: String(e) };
  }
}

sendBtn.onclick = async () => {
  const pw = pwEl.value;
  if(!pw){ alert('Password required'); return; }
  const text = inputEl.value.trim();
  if(!text) return;
  appendMsg('You', text);
  inputEl.value = '';
  const res = await callWorker({ password: pw, message: text });
  if(res.error) {
    appendMsg('Error', res.error);
    return;
  }
  if(res.reply) {
    replyArea.textContent = res.reply;
    appendMsg('Ashen', res.reply);
  }
  if(res.tabs) renderTabs(res.tabs);
  if(res.console) renderConsole(res.console);
};

openBtn.onclick = async () => {
  const pw = pwEl.value;
  const url = openUrl.value.trim();
  if(!pw){ alert('Password required'); return; }
  if(!url){ alert('Provide a URL'); return; }
  appendMsg('You', `open_tab ${url}`);
  const res = await callWorker({ password: pw, command: { type:'open_tab', url, fetchNow: true, summarizeAfter: true, words: 80 } });
  if(res.error) appendMsg('Error', res.error);
  else{
    appendMsg('System', `Opened tab ${res.tab.id}`);
    renderTabs(res.tabs);
    renderConsole(res.console);
  }
};

refreshTabsBtn.onclick = async () => {
  const pw = pwEl.value;
  if(!pw){ alert('Password required'); return; }
  const res = await callWorker({ password: pw, command: { type:'list_tabs' } });
  if(res.tabs) renderTabs(res.tabs);
  if(res.console) renderConsole(res.console);
};

function renderTabs(tabs){
  tabsList.innerHTML = '';
  for(const t of tabs){
    const div = document.createElement('div');
    div.className='tab';
    div.innerHTML = `<div><input type="radio" name="tab" value="${t.id}" ${t.id===selectedTabId?'checked':''}/> <b>${escapeHtml(t.title||t.url)}</b></div>
      <div class="small">${escapeHtml(t.url)}</div>
      <div class="small">status: ${t.status} lastFetched: ${t.lastFetchedAt||'n/a'}</div>`;
    tabsList.appendChild(div);
  }
  // attach radio click listeners
  Array.from(tabsList.querySelectorAll('input[name="tab"]')).forEach(i=>i.onclick=()=>{ selectedTabId = i.value; });
}

fetchTabBtn.onclick = async () => {
  if(!selectedTabId){ alert('Select a tab from the right'); return; }
  const pw = pwEl.value; if(!pw){ alert('Password needed'); return; }
  const res = await callWorker({ password: pw, command: { type:'fetch_tab', tabId: selectedTabId }});
  if(res.tabs) renderTabs(res.tabs);
  if(res.console) renderConsole(res.console);
  appendMsg('System', `Fetch requested for ${selectedTabId}`);
};

summTabBtn.onclick = async () => {
  if(!selectedTabId){ alert('Select a tab'); return; }
  const pw = pwEl.value; if(!pw){ alert('Password needed'); return; }
  const res = await callWorker({ password: pw, command: { type:'summarize_tab', tabId: selectedTabId, words: 120 }});
  if(res.result) appendMsg('System', `Summary: ${res.result.summary}`);
  if(res.tabs) renderTabs(res.tabs);
  if(res.console) renderConsole(res.console);
};

closeTabBtn.onclick = async () => {
  if(!selectedTabId){ alert('Select a tab'); return; }
  const pw = pwEl.value; if(!pw){ alert('Password needed'); return; }
  const res = await callWorker({ password: pw, command: { type:'close_tab', tabId: selectedTabId }});
  if(res.tabs) renderTabs(res.tabs);
  if(res.console) renderConsole(res.console);
  appendMsg('System', `Closed ${selectedTabId}`);
};

function renderConsole(entries){
  consoleDiv.innerHTML = '';
  for(const e of entries.slice(-200).reverse()){
    const line = document.createElement('div');
    line.innerHTML = `<span class="small">[${e.ts}]</span> <b>${escapeHtml(e.level)}</b> ${escapeHtml(e.msg)}`;
    consoleDiv.appendChild(line);
  }
  consoleDiv.scrollTop = consoleDiv.scrollHeight;
}

// initial load
(async ()=>{ const res = await callWorker({ password: pwEl.value || "", command: { type:'list_tabs' } }); if(res.tabs) renderTabs(res.tabs); if(res.console) renderConsole(res.console); })();
</script>
</body>
</html>
